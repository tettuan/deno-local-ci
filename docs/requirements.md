# 要求事項

## 利用者の欲求・背景

### 根源的欲求

Deno のテストを効率よく行い、問題に早期対処する。
GitHub Actions で判明する前に、同等以上の確認を local 環境で実行し、検知したい。

同時に、デバッグを効率よく行うために、テスト設計に基づいた順次実行を兼ね備え、品質保証だけではなくデバッグ容易性を重視したい。

## 機能要件

### 実行速度モードの提供
- **All モード**: 従来型、全テストを一度に実行。通る見込みが高いときに最速で終わる。なお、プロジェクト直下のフォルダ1つずつを順番に実行する。

- **Batch モード**: 大量テストが失敗する可能性のあるとき。効率性を重視、指定したサイズのバッチでテストを実行。

- **Single-file モード**: デバッグ時の詳細調査用、テストファイルを1つずつ実行（デフォルト）。時間がかかる。

### フォールバック機能
- **All モード**: All モードで失敗した場合、自動的にBatch モードへ移行する。
- **Batch モード**: Batch モードで失敗した場合、自動的に Single-file モードへフォールバック。バッチ単位で動作検証し、問題があれば1つずつ実行することで、速度と順次処理を両立する狙いがある。Single-file モード移行では、エラーが起きたバッチ範囲のみテストする。（全件やり直しではない）

- **Single-file モード**: エラーが起きたファイルで停止。段階的なエラー特定により、問題のあるファイルを順番に発見し、実施順に解決していく。テスト戦略でナンバリングされていることを前提とした実装である。このときの

### チェック機能
- TypeScript の型チェック
- JSR（JavaScript Registry）互換性チェック
- パッケージ公開前の事前検証

### CI パイプライン処理
- 型チェック → JSR チェック → テスト実行 → フォーマット/リント の順次実行
- 各段階での失敗時に、停止する。（次の段階へ進まない。）

### 6. ログ・診断機能
- **Debug モード**: 詳細なログ出力。BreakdownLoggerのLOG_LENGTH,LOG_KEYを巧みに使う。
- **Silent モード**: エラーのみ表示
- **Error-files-only モード**: エラーファイル一覧のみ表示

### 7. 実行時の設定
- コマンドライン引数による動的設定
  - バッチサイズの調整可能
  - 実行速度モード
- 環境変数による設定（LOG_LEVEL, LOG_LENGTH, LOG_KEY）
- Deno標準のテストファイル絞り込み機能の利用（filter）

### 8. パフォーマンス最適化
- メモリ効率的な大規模テストスイートの処理
- lockfile の自動再生成によるキャッシュ最適化
- チャンク分割による効率的な並列処理

### 対象ファイル
- テスト: *_test.ts | *.test.ts
- 型チェック: *.ts | *.tsx | *.d.ts
- 設定ファイル: deno.json | deno.lock | import_map.json


## 非機能要件

### 1. 信頼性
- エラー発生時の適切なフォールバック
- ロバストなエラーハンドリング
- 予期しない終了の防止

### 2. 使いやすさ
- 直感的なコマンドライン インターフェース
- 包括的なヘルプ機能
- プログラマティック API の提供

### 3. 保守性
- TypeScript による型安全性
- モジュラー設計
- 明確な責任分離（CI Runner, Logger, Process Runner など）

### 4. 拡張性
- 新しい実行モードの追加容易性
- プラグイン型アーキテクチャ
- 設定オプションの柔軟な拡張

### 5. パフォーマンス
- 大規模プロジェクトでのスケーラビリティ
- 最適化されたリソース使用
- 適切なメモリ管理

## 技術要件

### 1. プラットフォーム
- Deno ランタイム
- TypeScript 言語
- macOS/Linux/Windows 対応

### 2. 依存関係
- Deno 標準ライブラリ (@std/path)
- 最小限の外部依存

### 3. 権限要求
- `--allow-read`: ファイル読み取り
- `--allow-write`: ファイル書き込み
- `--allow-run`: 外部プロセス実行
- `--allow-env`: 環境変数アクセス

### 4. 配布
- JSR（JavaScript Registry）経由での配布
- GitHub リポジトリでのソース管理
- npm/deno パッケージマネージャー対応






